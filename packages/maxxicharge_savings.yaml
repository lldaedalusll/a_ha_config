###############################################################################
#  PACKAGE: Solar Savings â€“ Version 7 (final, float(-9999))
###############################################################################

###############################################################################
#  INPUT NUMBERS (Persistente Summen)
###############################################################################
input_number:
  saving_pv_total:
    name: "Gesamt-Ersparnis PV"
    icon: mdi:currency-eur
    min: 0
    max: 1000000
    step: 0.000001
    unit_of_measurement: "â‚¬"
    mode: box

  saving_battery:
    name: "Ersparnis Batterie"
    icon: mdi:battery
    min: 0
    max: 1000000
    step: 0.000001
    unit_of_measurement: "â‚¬"
    mode: box

  saving_pv_passthrough:
    name: "Ersparnis PV-Direktnutzung"
    icon: mdi:solar-power
    min: 0
    max: 1000000
    step: 0.000001
    unit_of_measurement: "â‚¬"
    mode: box

  last_bkw_update:
    name: "Letztes BKW-Update"
    min: 0
    max: 9999999999
    step: 0.000001



###############################################################################
#  DEBUG-SCHALTER
###############################################################################
input_boolean:
  solar_savings_debug:
    name: "Solar Savings Debug Logging"
    icon: mdi:bug


###############################################################################
#  HILFSSENSOREN
###############################################################################
#input_datetime:
#  last_bkw_update:
#    name: "Letztes BKW-Update"
#    has_date: true
#    has_time: true


###############################################################################
#  TEMPLATE-SENSOREN
###############################################################################
template:
  - sensor:
      - name: "saving.pv_total"
        unique_id: "saving_pv_total_template"
        unit_of_measurement: "â‚¬"
        icon: mdi:currency-eur
        state: "{{ states('input_number.saving_pv_total') | float(-9999) | round(2) }}"

      - name: "saving.battery"
        unique_id: "saving_battery_template"
        unit_of_measurement: "â‚¬"
        icon: mdi:battery
        state: "{{ states('input_number.saving_battery') | float(-9999) | round(2) }}"

      - name: "saving.pv_passthrough"
        unique_id: "saving_pv_passthrough_template"
        unit_of_measurement: "â‚¬"
        icon: mdi:solar-power
        state: "{{ states('input_number.saving_pv_passthrough') | float(-9999) | round(2) }}"


###############################################################################
#  AUTOMATIONEN
###############################################################################
automation:

  ###########################################################################
  # 0ï¸âƒ£ Initialisierung bei Systemstart
  ###########################################################################
  - alias: "Ersparnis-ZÃ¤hler initialisieren"
    id: init_solar_savings
    trigger:
      - platform: homeassistant
        event: start
    condition:
      - condition: or
        conditions:
          - "{{ states('input_number.saving_pv_total') in ['unknown','unavailable','none'] }}"
          - "{{ states('input_number.saving_battery') in ['unknown','unavailable','none'] }}"
          - "{{ states('input_number.saving_pv_passthrough') in ['unknown','unavailable','none'] }}"
    action:
      - service: input_number.set_value
        target:
          entity_id:
            - input_number.saving_pv_total
            - input_number.saving_battery
            - input_number.saving_pv_passthrough
        data:
          value: 0
      - service: logbook.log
        data:
          name: "Solar Savings Init"
          message: "Initialisiert alle Ersparnis-ZÃ¤hler auf 0 (erstmaliger Start)"


  ###########################################################################
  # 1ï¸âƒ£ Einsparung Batterie â€“ sofortige Aufsummierung
  ###########################################################################
  - alias: "Einsparung Batterie sofort aufsummieren"
    id: solar_savings_increment_battery
    mode: queued
    trigger:
      - platform: state
        entity_id: sensor.power_self_used_from_ccu_bat_discharge
    action:
      - variables:
          now_ts: "{{ as_timestamp(now()) | int }}"
          last_ts: >-
            {% set t = states('input_number.last_bkw_update') | float(0) %}
            {{ t if t not in ['unknown','unavailable','none',''] else as_timestamp(now()) }}

          dt_sec: "{{ now_ts - last_ts }}"
          dt_sec_clamped: "{{ min(dt_sec, 30) }}"
          dt_h: "{{ dt_sec_clamped / 3600 }}"

          power_bat: "{{ states('sensor.power_self_used_from_ccu_bat_discharge') | float(-9999) }}"
          energy_bat: "{{ (power_bat | float(0) * dt_h | float(0)) / 1000 }}"
          price: "{{ states('sensor.strom_preis_pro_kwh') | float(-9999) }}"
          delta_bat_eur: "{{ energy_bat | float(0) * price | float(0) }}"

          debug_bat_v1: >
            [DEBUG BAT V1]
            now_ts={{ now_ts | float(-9999) }}
            last_ts={{ last_ts | float(-9999) }}
            dt_sec={{ dt_sec | float(-9999) }}
            dt_h={{ dt_h | float(-9999) }}
            power_bat={{ power_bat | float(-9999) }}
            energy_bat={{ energy_bat | float(-9999) }}
            price={{ price | float(-9999) }}
            delta_bat_eur={{ delta_bat_eur | float(-9999) }}

      - choose:
          - conditions: "{{ is_state('input_boolean.solar_savings_debug','on') }}"
            sequence:
              - service: system_log.write
                data:
                  level: warning
                  message: "{{ debug_bat_v1 }}"

      - choose:
          - conditions: "{{ is_state('input_boolean.solar_savings_debug','on') }}"
            sequence:
              - service: logbook.log
                data:
                  name: "Solar Savings"
                  message: >
                    ğŸ”‹ Batterie: power={{ power_bat }} W,
                    dt={{ dt_h | round(6) }} h,
                    Î”={{ delta_bat_eur | round(6) }} â‚¬,
                    price={{ price }} â‚¬/kWh

      - if:
          - "{{ delta_bat_eur | float(-9999) > 0 }}"
        then:
          - variables:
              debug_bat_v2: >
                [DEBUG BAT V2]
                saving_raw={{ states('input_number.saving_battery') }}
                saving_float={{ states('input_number.saving_battery') | float(-9999) }}
                delta={{ delta_bat_eur }}
                delta_float={{ delta_bat_eur | float(-9999) }}

          - choose:
              - conditions: "{{ is_state('input_boolean.solar_savings_debug','on') }}"
                sequence:
                  - service: system_log.write
                    data:
                      level: warning
                      message: "{{ debug_bat_v2 }}"

          - service: input_number.set_value
            target:
              entity_id: input_number.saving_battery
            data:
              value: "{{ (states('input_number.saving_battery') | float(-9999) + delta_bat_eur | float(0) ) | round(6) }}"

          - service: input_number.set_value
            target:
              entity_id: input_number.saving_pv_total
            data:
              value: "{{ (states('input_number.saving_pv_total') | float(-9999) + delta_bat_eur | float(0) ) | round(6) }}"

      - service: input_number.set_value
        target:
          entity_id: input_number.last_bkw_update
        data:
          value: "{{ now_ts }}"


  ###########################################################################
  # 2ï¸âƒ£ Einsparung PV-Direktnutzung â€“ sofortige Aufsummierung
  ###########################################################################
  - alias: "Einsparung PV Passthrough sofort aufsummieren"
    id: solar_savings_increment_pv_passthrough
    mode: queued
    trigger:
      - platform: state
        entity_id: sensor.power_self_used_from_ccu_passthrough
    action:
      - variables:
          now_ts: "{{ as_timestamp(now()) | int }}"
          last_ts: >-
            {% set t = states('input_number.last_bkw_update') | float(0) %}
            {{ t if t not in ['unknown','unavailable','none',''] else as_timestamp(now()) }}

          dt_sec: "{{ now_ts - last_ts }}"
          dt_sec_clamped: "{{ min(dt_sec, 30) }}"
          dt_h: "{{ dt_sec_clamped / 3600 }}"

          power_pv: "{{ states('sensor.power_self_used_from_ccu_passthrough') | float(-9999) }}"
          energy_pv: "{{ (power_pv | float(0) * dt_h | float(0)) / 1000 }}"
          price: "{{ states('sensor.strom_preis_pro_kwh') | float(-9999) }}"
          delta_pv_eur: "{{ energy_pv | float(0) * price | float(0) }}"

          debug_pv_v1: >
            [DEBUG PV V1]
            now_ts={{ now_ts | float(-9999) }}
            last_ts={{ last_ts | float(-9999) }}
            dt_sec={{ dt_sec | float(-9999) }}
            dt_h={{ dt_h | float(-9999) }}
            power_pv={{ power_pv | float(-9999) }}
            energy_pv={{ energy_pv | float(-9999) }}
            price={{ price | float(-9999) }}
            delta_pv_eur={{ delta_pv_eur | float(-9999) }}

      - choose:
          - conditions: "{{ is_state('input_boolean.solar_savings_debug','on') }}"
            sequence:
              - service: system_log.write
                data:
                  level: warning
                  message: "{{ debug_pv_v1 }}"

      - choose:
          - conditions: "{{ is_state('input_boolean.solar_savings_debug','on') }}"
            sequence:
              - service: logbook.log
                data:
                  name: "Solar Savings"
                  message: >
                    â˜€ï¸ PV Passthrough: power={{ power_pv }} W,
                    dt={{ dt_h | round(6) }} h,
                    Î”={{ delta_pv_eur | round(6) }} â‚¬,
                    price={{ price }} â‚¬/kWh

      - if:
          - "{{ delta_pv_eur | float(-9999) > 0 }}"
        then:
          - variables:
              debug_pv_v2: >
                [DEBUG PV V2]
                saving_raw={{ states('input_number.saving_pv_passthrough') }}
                saving_float={{ states('input_number.saving_pv_passthrough') | float(-9999) }}
                delta={{ delta_pv_eur }}
                delta_float={{ delta_pv_eur | float(-9999) }}

          - choose:
              - conditions: "{{ is_state('input_boolean.solar_savings_debug','on') }}"
                sequence:
                  - service: system_log.write
                    data:
                      level: warning
                      message: "{{ debug_pv_v2 }}"

          - service: input_number.set_value
            target:
              entity_id: input_number.saving_pv_passthrough
            data:
              value: "{{ (states('input_number.saving_pv_passthrough') | float(-9999) + delta_pv_eur | float(0) ) | round(6) }}"

          - service: input_number.set_value
            target:
              entity_id: input_number.saving_pv_total
            data:
              value: "{{ (states('input_number.saving_pv_total') | float(-9999) + delta_pv_eur | float(0) ) | round(6) }}"

      - service: input_number.set_value
        target:
          entity_id: input_number.last_bkw_update
        data:
          value: "{{ now_ts | float }}"
